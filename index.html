<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©tective DPE - Lupin Edition</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f6f7; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--primary); padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--primary); margin-bottom: 5px; }
        p.subtitle { text-align: center; color: #666; margin-bottom: 25px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .full-width { grid-column: span 2; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background-color: var(--accent); color: white; border: none; border-radius: 6px; font-size: 1.1em; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { background-color: #2980b9; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.85em; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: var(--primary); color: white; font-weight: 500; }
        tr:hover { background-color: #f8f9fa; }
        
        .badge { padding: 3px 6px; border-radius: 4px; color: white; font-weight: bold; font-size: 0.8em; display: inline-block; }
        .badge-A { background: #009c3d; } .badge-B { background: #52b153; }
        .badge-C { background: #78bd76; } .badge-D { background: #f4e70f; color: black; }
        .badge-E { background: #f0b50f; } .badge-F { background: #eb8235; } .badge-G { background: #d7221f; }
        
        .source-tag { padding: 4px 8px; border-radius: 4px; font-size: 0.7em; font-weight: bold; text-transform: uppercase; color: white; }
        .source-new { background: #3498db; }
        .source-old { background: #7f8c8d; }

        .loader { text-align: center; display: none; margin: 20px; font-weight: bold; color: var(--accent); }
        .addr-cell { line-height: 1.4; }
        .addr-cell strong { color: #2c3e50; font-size: 1.05em; }
    </style>
</head>
<body>

<div class="container">
    <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è D√©tective DPE</h1>
    <p class="subtitle">Recherche simultan√©e (Anciennes & Nouvelles bases ADEME)</p>
    
    <div class="grid">
        <div class="full-width">
            <label>Code Postal (Obligatoire)</label>
            <input type="number" id="cp" placeholder="ex: 24360" value="24360">
        </div>

        <div>
            <label>Conso (kWh/m¬≤)</label>
            <input type="number" id="conso" placeholder="ex: 154">
        </div>
        <div>
            <label>GES (kgCO2)</label>
            <input type="number" id="ges" placeholder="ex: 33">
        </div>

        <div class="full-width">
            <label>Surface Habitable (m¬≤ - Optionnel)</label>
            <input type="number" id="surface" placeholder="Surface du logement (pas du terrain)">
        </div>
        
        <div class="full-width">
            <label>Date du DPE (Optionnel)</label>
            <input type="date" id="date">
        </div>
    </div>

    <button onclick="lancerRecherche()">Lancer la recherche</button>

    <div id="loader" class="loader">‚è≥ Scan des archives ADEME en cours...</div>
    <div id="resultats"></div>
</div>

<script>
async function lancerRecherche() {
    const cpValue = document.getElementById('cp').value.trim();
    const consoVal = parseFloat(document.getElementById('conso').value);
    const gesVal = parseFloat(document.getElementById('ges').value);
    const surfVal = parseFloat(document.getElementById('surface').value);
    const dateVal = document.getElementById('date').value;
    const divRes = document.getElementById('resultats');
    const loader = document.getElementById('loader');

    if (!cpValue) { alert("Le Code Postal est obligatoire !"); return; }

    divRes.innerHTML = "";
    loader.style.display = "block";

    const p1 = searchNewDPE(cpValue, dateVal);
    const p2 = searchOldDPE(cpValue, dateVal);

    try {
        const [resNew, resOld] = await Promise.all([p1, p2]);
        let all = [...resNew, ...resOld];

        all = all.map(item => {
            let score = 0;
            if (consoVal) {
                const diff = Math.abs(item.conso - consoVal);
                if (diff < 1) score += 100;
                else if (diff < 5) score += 80;
                else if (diff < 15) score += 40;
            }
            if (gesVal) {
                const diff = Math.abs(item.ges - gesVal);
                if (diff < 1) score += 50;
                else if (diff < 5) score += 30;
            }
            if (surfVal && item.surface > 0) {
                const diff = Math.abs(item.surface - surfVal);
                if (diff < 5) score += 60;
                else if (diff < 20) score += 30;
            }
            if (dateVal && item.date === dateVal) score += 200;
            item.score = score;
            return item;
        });

        all = all.filter(x => x.score > 0).sort((a, b) => b.score - a.score);
        const top = all.slice(0, 100);

        loader.style.display = "none";

        if (top.length === 0) {
            divRes.innerHTML = "<p style='text-align:center; padding:20px;'>‚ùå Aucun bien ne correspond √† ces crit√®res dans cette zone.</p>";
            return;
        }

        let html = `<h3>‚úÖ ${top.length} pistes trouv√©es :</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Adresse (Pr√™te pour Maps)</th>
                                <th>Surface</th>
                                <th>Conso/GES</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>`;
        
        top.forEach(r => {
            let bg = r.score > 120 ? "#d4efdf" : "white";
            const dateFr = r.date.split('-').reverse().join('/');
            
            html += `<tr style="background:${bg}">
                        <td><span class="source-tag ${r.source === 'Nouveau' ? 'source-new' : 'source-old'}">${r.source}</span></td>
                        <td class="addr-cell"><strong>${r.adresse}</strong><br>${cpValue} ${r.ville}</td>
                        <td><strong>${r.surface} m¬≤</strong></td>
                        <td>
                            <span class="badge badge-${r.dpe}">${r.dpe}</span> ${r.conso.toFixed(0)}<br>
                            <span class="badge" style="background:#666">${r.gesLet}</span> ${r.ges.toFixed(0)}
                        </td>
                        <td>${dateFr}</td>
                     </tr>`;
        });
        html += "</tbody></table>";
        divRes.innerHTML = html;

    } catch (e) {
        loader.style.display = "none";
        divRes.innerHTML = "Erreur : " + e.message;
    }
}

async function searchNewDPE(cp, date) {
    let url = `https://data.ademe.fr/data-fair/api/v1/datasets/dpe03existant/lines?page=1&size=3000&q=${cp}`;
    if(date) url += " " + date;
    try {
        const req = await fetch(url);
        const json = await req.json();
        return (json.results || []).map(r => {
            if(!String(r.code_postal_brut).includes(cp)) return null;
            return {
                source: "Nouveau",
                adresse: r.adresse_brut || r.nom_rue || "Adresse masqu√©e",
                ville: r.nom_commune_brut || "",
                surface: r.surface_habitable_logement || r.surface_habitable || 0,
                conso: r.conso_5_usages_par_m2_ep || 0,
                ges: r.emission_ges_5_usages_par_m2 || 0,
                dpe: r.etiquette_dpe || "?",
                gesLet: r.etiquette_ges || "?",
                date: (r.date_visite_diagnostiqueur || "").substring(0, 10)
            };
        }).filter(x => x);
    } catch (e) { return []; }
}

async function searchOldDPE(cp, date) {
    let url = `https://data.ademe.fr/data-fair/api/v1/datasets/dpe-v2-logements-existants/lines?page=1&size=3000&q=${cp}`;
    try {
        const req = await fetch(url);
        const json = await req.json();
        return (json.results || []).map(r => {
            if(!String(r.code_postal_brut).includes(cp)) return null;
            return {
                source: "Ancien",
                adresse: r.adresse_brut || r.nom_rue || "Adresse masqu√©e",
                ville: r.nom_commune_brut || "",
                surface: r.surface_habitable || 0,
                conso: r.consommation_energie || 0,
                ges: r.estimation_ges || 0,
                dpe: r.classe_consommation_energie || "?",
                gesLet: r.classe_estimation_ges || "?",
                date: (r.date_etablissement_dpe || "").substring(0, 10)
            };
        }).filter(x => x);
    } catch (e) { return []; }
}
</script>

</body>
</html>
